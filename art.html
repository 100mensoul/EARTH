<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ノイズアート - 音で描く</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        color: white;
    }

    .container {
        width: 100%;
        max-width: 800px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    h1 {
        text-align: center;
        margin-bottom: 10px;
        font-size: 2em;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .subtitle {
        text-align: center;
        margin-bottom: 30px;
        opacity: 0.9;
        font-size: 0.9em;
    }

    canvas {
        width: 100%;
        height: 400px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        margin-bottom: 20px;
        cursor: crosshair;
    }

    .controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
        margin-bottom: 20px;
    }

    button {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.3);
        padding: 12px 24px;
        border-radius: 25px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
    }

    button:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    button.active {
        background: rgba(255, 255, 255, 0.4);
        border-color: white;
    }

    .info {
        display: flex;
        justify-content: space-around;
        text-align: center;
        padding: 15px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .info-item {
        flex: 1;
    }

    .info-label {
        font-size: 0.85em;
        opacity: 0.8;
        margin-bottom: 5px;
    }

    .info-value {
        font-size: 1.5em;
        font-weight: bold;
    }

    .mode-selector {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-bottom: 20px;
    }

    .mode-btn {
        padding: 8px 16px;
        font-size: 14px;
        border-radius: 20px;
    }

    #permission-message {
        text-align: center;
        padding: 20px;
        background: rgba(255, 200, 0, 0.2);
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .slider-container {
        margin: 20px 0;
    }

    .slider-label {
        margin-bottom: 5px;
        font-size: 0.9em;
    }

    input[type="range"] {
        width: 100%;
        height: 6px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 3px;
        outline: none;
        -webkit-appearance: none;
    }

    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        cursor: pointer;
    }

    input[type="range"]::-moz-range-thumb {
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        cursor: pointer;
        border: none;
    }
</style>
```

</head>
<body>
    <div class="container">
        <h1>🎨 ノイズアート</h1>
        <p class="subtitle">周囲の音を美しいアートに変換します</p>

```
    <div id="permission-message">
        「録音開始」ボタンを押してマイクの使用を許可してください
    </div>

    <canvas id="canvas"></canvas>

    <div class="info">
        <div class="info-item">
            <div class="info-label">音量レベル</div>
            <div class="info-value" id="volume">0</div>
        </div>
        <div class="info-item">
            <div class="info-label">周波数ピーク</div>
            <div class="info-value" id="frequency">0 Hz</div>
        </div>
        <div class="info-item">
            <div class="info-label">ノイズタイプ</div>
            <div class="info-value" id="noise-type">-</div>
        </div>
    </div>

    <div class="mode-selector">
        <button class="mode-btn active" data-mode="particles">パーティクル</button>
        <button class="mode-btn" data-mode="waves">波形</button>
        <button class="mode-btn" data-mode="spiral">スパイラル</button>
        <button class="mode-btn" data-mode="tree">ツリー</button>
    </div>

    <div class="slider-container">
        <div class="slider-label">感度: <span id="sensitivity-value">5</span></div>
        <input type="range" id="sensitivity" min="1" max="10" value="5">
    </div>

    <div class="controls">
        <button id="startBtn">🎤 録音開始</button>
        <button id="clearBtn">🗑️ クリア</button>
        <button id="saveBtn">💾 保存</button>
    </div>
</div>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const startBtn = document.getElementById('startBtn');
    const clearBtn = document.getElementById('clearBtn');
    const saveBtn = document.getElementById('saveBtn');
    const volumeDisplay = document.getElementById('volume');
    const frequencyDisplay = document.getElementById('frequency');
    const noiseTypeDisplay = document.getElementById('noise-type');
    const permissionMessage = document.getElementById('permission-message');
    const sensitivitySlider = document.getElementById('sensitivity');
    const sensitivityValue = document.getElementById('sensitivity-value');

    let audioContext;
    let analyser;
    let microphone;
    let isRecording = false;
    let animationId;
    let currentMode = 'particles';
    let sensitivity = 5;

    // Canvas setup
    canvas.width = canvas.offsetWidth * 2;
    canvas.height = canvas.offsetHeight * 2;
    ctx.scale(2, 2);

    // Particle system
    const particles = [];
    const maxParticles = 100;

    // Mode selection
    document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentMode = btn.dataset.mode;
        });
    });

    // Sensitivity control
    sensitivitySlider.addEventListener('input', (e) => {
        sensitivity = parseInt(e.target.value);
        sensitivityValue.textContent = sensitivity;
    });

    class Particle {
        constructor(x, y, size, color, velocity) {
            this.x = x;
            this.y = y;
            this.size = size;
            this.color = color;
            this.velocity = velocity;
            this.life = 1.0;
            this.decay = 0.01;
        }

        update() {
            this.x += this.velocity.x;
            this.y += this.velocity.y;
            this.life -= this.decay;
            this.size *= 0.99;
        }

        draw() {
            ctx.save();
            ctx.globalAlpha = this.life;
            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
        }
    }

    function getColorFromFrequency(frequency) {
        const hue = (frequency / 20000) * 360;
        return `hsl(${hue}, 70%, 50%)`;
    }

    function analyzeNoiseType(frequencyData, volume) {
        const avg = frequencyData.reduce((a, b) => a + b) / frequencyData.length;
        
        if (volume > 80) return "大きな騒音";
        if (volume > 60) return "ざわめき";
        if (volume > 40) return "会話";
        if (volume > 20) return "静かな音";
        return "ほぼ無音";
    }

    function drawParticles(frequencyData, volume) {
        const centerX = canvas.width / 4;
        const centerY = canvas.height / 4;
        
        if (volume > 20) {
            const angle = Math.random() * Math.PI * 2;
            const speed = (volume / 100) * sensitivity;
            const size = Math.max(1, (volume / 100) * 10);
            const color = getColorFromFrequency(Math.max(...frequencyData) * 100);
            
            particles.push(new Particle(
                centerX,
                centerY,
                size,
                color,
                {
                    x: Math.cos(angle) * speed,
                    y: Math.sin(angle) * speed
                }
            ));
        }
        
        if (particles.length > maxParticles) {
            particles.shift();
        }
        
        particles.forEach((particle, index) => {
            particle.update();
            particle.draw();
            
            if (particle.life <= 0) {
                particles.splice(index, 1);
            }
        });
    }

    function drawWaves(frequencyData, volume) {
        const width = canvas.width / 2;
        const height = canvas.height / 2;
        const barWidth = width / frequencyData.length;
        
        ctx.fillStyle = 'rgba(255, 255, 255, 0.02)';
        ctx.fillRect(0, 0, width, height);
        
        frequencyData.forEach((value, index) => {
            const barHeight = (value / 255) * height * (sensitivity / 5);
            const color = getColorFromFrequency(index * 100);
            
            ctx.fillStyle = color;
            ctx.globalAlpha = 0.7;
            ctx.fillRect(
                index * barWidth,
                height - barHeight,
                barWidth - 1,
                barHeight
            );
        });
    }

    let spiralAngle = 0;
    function drawSpiral(frequencyData, volume) {
        const centerX = canvas.width / 4;
        const centerY = canvas.height / 4;
        
        ctx.fillStyle = 'rgba(255, 255, 255, 0.01)';
        ctx.fillRect(0, 0, canvas.width / 2, canvas.height / 2);
        
        const radius = (volume / 100) * 100 * (sensitivity / 5);
        const x = centerX + Math.cos(spiralAngle) * radius;
        const y = centerY + Math.sin(spiralAngle) * radius;
        
        const color = getColorFromFrequency(Math.max(...frequencyData) * 100);
        const size = Math.max(1, (volume / 100) * 5);
        
        ctx.fillStyle = color;
        ctx.globalAlpha = 0.8;
        ctx.beginPath();
        ctx.arc(x, y, size, 0, Math.PI * 2);
        ctx.fill();
        
        spiralAngle += 0.1;
    }

    let branches = [];
    function drawTree(frequencyData, volume) {
        const centerX = canvas.width / 4;
        const centerY = canvas.height / 2;
        
        ctx.fillStyle = 'rgba(255, 255, 255, 0.02)';
        ctx.fillRect(0, 0, canvas.width / 2, canvas.height / 2);
        
        if (volume > 30 && Math.random() < 0.1) {
            const angle = (Math.random() - 0.5) * Math.PI;
            const length = (volume / 100) * 50 * (sensitivity / 5);
            const color = getColorFromFrequency(Math.max(...frequencyData) * 100);
            
            branches.push({
                x: centerX,
                y: centerY,
                angle: angle,
                length: length,
                color: color,
                life: 1.0
            });
        }
        
        branches = branches.filter(branch => branch.life > 0);
        
        branches.forEach(branch => {
            ctx.strokeStyle = branch.color;
            ctx.globalAlpha = branch.life;
            ctx.lineWidth = branch.life * 3;
            ctx.beginPath();
            ctx.moveTo(branch.x, branch.y);
            const endX = branch.x + Math.cos(branch.angle) * branch.length;
            const endY = branch.y + Math.sin(branch.angle) * branch.length;
            ctx.lineTo(endX, endY);
            ctx.stroke();
            
            branch.life -= 0.01;
        });
    }

    function visualize() {
        if (!isRecording) return;
        
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        analyser.getByteFrequencyData(dataArray);
        
        const volume = Math.round(dataArray.reduce((a, b) => a + b) / bufferLength);
        volumeDisplay.textContent = volume;
        
        const maxFreqIndex = dataArray.indexOf(Math.max(...dataArray));
        const frequency = Math.round((maxFreqIndex / bufferLength) * 22050);
        frequencyDisplay.textContent = frequency + ' Hz';
        
        noiseTypeDisplay.textContent = analyzeNoiseType(dataArray, volume);
        
        // Draw based on selected mode
        switch(currentMode) {
            case 'particles':
                drawParticles(dataArray, volume);
                break;
            case 'waves':
                drawWaves(dataArray, volume);
                break;
            case 'spiral':
                drawSpiral(dataArray, volume);
                break;
            case 'tree':
                drawTree(dataArray, volume);
                break;
        }
        
        animationId = requestAnimationFrame(visualize);
    }

    async function startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            microphone = audioContext.createMediaStreamSource(stream);
            
            analyser.fftSize = 256;
            microphone.connect(analyser);
            
            isRecording = true;
            startBtn.textContent = '⏹️ 録音停止';
            permissionMessage.style.display = 'none';
            visualize();
        } catch (err) {
            console.error('マイクへのアクセスが拒否されました:', err);
            permissionMessage.textContent = 'マイクへのアクセスが拒否されました。ブラウザの設定を確認してください。';
            permissionMessage.style.background = 'rgba(255, 0, 0, 0.2)';
        }
    }

    function stopRecording() {
        isRecording = false;
        if (microphone) {
            microphone.disconnect();
        }
        if (audioContext) {
            audioContext.close();
        }
        if (animationId) {
            cancelAnimationFrame(animationId);
        }
        startBtn.textContent = '🎤 録音開始';
    }

    startBtn.addEventListener('click', () => {
        if (isRecording) {
            stopRecording();
        } else {
            startRecording();
        }
    });

    clearBtn.addEventListener('click', () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width / 2, canvas.height / 2);
        particles.length = 0;
        branches.length = 0;
        spiralAngle = 0;
    });

    saveBtn.addEventListener('click', () => {
        const link = document.createElement('a');
        link.download = `noise-art-${Date.now()}.png`;
        link.href = canvas.toDataURL();
        link.click();
    });

    // Initialize canvas
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, canvas.width / 2, canvas.height / 2);
</script>
```

</body>
</html>